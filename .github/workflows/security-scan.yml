name: Security Scan

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Only required for Organizations

  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: './webui'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Report but don't fail - vulnerabilities show in Security tab

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  file-patterns:
    name: Check for Sensitive Files
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files and patterns..."

          # Files that should never be committed
          FORBIDDEN_FILES=(
            ".env"
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            "id_rsa"
            "id_dsa"
            "*.crt"
            "credentials.json"
            "auth.json"
            "secrets.yml"
            "secrets.yaml"
          )

          FOUND_ISSUES=0

          for pattern in "${FORBIDDEN_FILES[@]}"; do
            if find . -name "$pattern" -not -path "./.git/*" | grep -q .; then
              echo "❌ FOUND SENSITIVE FILE: $pattern"
              find . -name "$pattern" -not -path "./.git/*"
              FOUND_ISSUES=1
            fi
          done

          # Check for common patterns in code (exclude constants, examples, and documentation)
          echo ""
          echo "Checking for hardcoded secrets patterns..."

          if grep -r -i --include="*.py" --include="*.yml" --include="*.yaml" --include="*.js" --include="*.ts" \
            -E "(password|passwd|pwd|secret|token|api_key|apikey)\s*=\s*['\"][^'\"]{8,}" \
            --exclude-dir=".git" --exclude-dir="node_modules" . \
            | grep -v ".example" \
            | grep -v "your-secure-random-token-here" \
            | grep -v "# Special token for testing" \
            | grep -v "# not a real secret" \
            | grep -v "constants.py" \
            | grep -v -E ":[A-Z_]*TOKEN\s*=" ; then
            echo "❌ FOUND POTENTIAL HARDCODED SECRETS"
            FOUND_ISSUES=1
          fi

          # Check for API keys/tokens patterns
          if grep -r -E "(sk-[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{36}|AIza[0-9A-Za-z_-]{35})" \
            --exclude-dir=".git" --exclude-dir="node_modules" . ; then
            echo "❌ FOUND API KEY PATTERNS"
            FOUND_ISSUES=1
          fi

          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "⚠️  Security check FAILED! Sensitive information detected."
            echo "Please remove sensitive files and hardcoded secrets before committing."
            exit 1
          else
            echo ""
            echo "✅ No sensitive files or patterns detected."
          fi


